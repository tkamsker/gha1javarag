<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<!-- @author: richard.gebauer@telekom.at -->
<sqlMap namespace="Image">
	<cacheModel id="image-cache" type="ehcacheProvider" readOnly="true" serialize="false">
		<flushInterval hours="3"/>
		<property name="cache-size" value="1000"/>
	</cacheModel>

	<parameterMap id="image-insert" class="java.util.Map">
		<parameter property="id"/>
		<parameter property="uuser" jdbcType="VARCHAR"/>
		<parameter property="filename"/>
		<parameter property="name"/>
		<parameter property="imageSizeId"/>
	</parameterMap>

	<insert id="SaveImage" parameterMap="image-insert">
		<selectKey keyProperty="id" resultClass="java.lang.Long" type="pre">
			SELECT seq_app_image.NEXTVAL AS id FROM DUAL
		</selectKey>
		INSERT INTO app_image (id, uuser, filename, name, image_size_id)
			 VALUES (?, ?, ?, ?, ?)
	</insert>

	<parameterMap id="image-update" class="java.util.Map">
		<parameter property="uuser" jdbcType="VARCHAR"/>
		<parameter property="filename" jdbcType="VARCHAR"/>
		<parameter property="name"/>
		<parameter property="imageSizeId"/>
	</parameterMap>

	<update id="UpdateImage" parameterMap="image-update">
		UPDATE app_image
		   SET uuser = ?,
		   	   filename = ?,
		   	   creation_date = SYSDATE
		 WHERE name = ?
		   AND image_size_id = ?
	</update>

	<resultMap id="image-result" class="at.a1ta.cuco.core.shared.dto.Image">
		<result property="id" column="id"/>
		<result property="uuser" column="uuser" jdbcType="VARCHAR"/>
		<result property="filename" column="filename"/>
		<result property="name" column="name"/>
		<result property="creationDate" column="creation_date"/>
		<result property="imageSizeId" column="image_size_id"/>
	</resultMap>

	<select id="GetImages" resultMap="image-result" parameterClass="java.util.Map">
		SELECT id, uuser, filename, name, creation_date, image_size_id
		  FROM app_image
		<dynamic prepend="WHERE">
			<isNotNull property="id" prepend="AND">
		  	   id = #id#
			</isNotNull>
			<isNotNull property="uuser" prepend="AND">
		  	   uuser = #uuser#
			</isNotNull>
			<isNotNull property="filename" prepend="AND">
		  	   filename = #filename#
			</isNotNull>
			<isNotNull property="name" prepend="AND">
		  	   name = #name#
			</isNotNull>
			<isNotNull property="imageSizeId" prepend="AND">
		  	   image_size_id = #imageSizeId#
			</isNotNull>
		</dynamic>
	  ORDER BY name, image_size_id, creation_date DESC
	</select>
</sqlMap>