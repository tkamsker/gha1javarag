<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="vbmProducts">
  <cacheModel id="vbmProducts-cache" type="ehcacheProvider" readOnly="true" serialize="false">
    <flushInterval minutes="1" />
    <property name="cache-size" value="1000" />
  </cacheModel>

  <cacheModel type="ehcacheProvider" id="parser-cache">
    <property name="cache-size" value="10" />
  </cacheModel>

  <resultMap id="vbmProductScoring-result" class="at.a1ta.cuco.core.shared.dto.nbo.VBMProduct">
    <result property="customerId" column="KUNDE_ID" />
    <result property="productId" column="PRODUCT_ID" />
    <result property="monthYearPeriod" column="MONTH_YEAR_PERIOD" />
    <result property="scoringTotal" column="SCORING" />
    <result property="productDetails" column="{productId=PRODUCT_ID}" select="vbmProducts.getProduktInfo" />
    <result property="productFeedback" column="{customerId=KUNDE_ID, productId=PRODUCT_ID,monthYearPeriod=MONTH_YEAR_PERIOD}" select="vbmProducts.getFeedbackForProdukt" />
    <result property="availableDeclineReasons" column="{productId=PRODUCT_ID}" select="vbmProducts.getAvailableFeedbackReasons" />
  </resultMap>

  <resultMap id="vbmProductFeedback-result" class="at.a1ta.cuco.core.shared.dto.nbo.VBMProductFeedback">
    <result property="customerId" column="KUNDE_ID" />
    <result property="productId" column="PRODUCT_ID" />
    <result property="monthYearPeriod" column="MONTH_YEAR_PERIOD" />
    <result property="feedBackGiven" column="FEEDBACK_YN" />
    <result property="selectedDeclineReason" column="{declineReasonId=FEEDBACK_REASON_ID}" select="vbmProducts.getFeedbackReasonById" />
    <result property="feedbackTime" column="FEEDBACK_TS" />
    <result property="feedbackUserName" column="FEEDBACK_USER_NAME" />
    <result property="feedbackUserId" column="FEEDBACK_USER_ID" />
  </resultMap>

  <resultMap id="vbmProductInfo-result" class="at.a1ta.cuco.core.shared.dto.nbo.VBMProductDetails">
    <result property="productId" column="PRODUCT_ID" />
    <result property="partWebProductId" column="PRODUCT_PARTNERWEB_ID" />
    <result property="clarifyProductId" column="PRODUCT_CLARIFY_ID" />
    <result property="productName" column="PRODUCT_NAME" />
    <result property="productDetailsURL" column="URL" />
    <result property="description" column="MARKETING_TEXT" />
    <result property="maxScoring" column="MAX_SCORING" />
  </resultMap>

  <resultMap id="vbmFeedbackReasons-result" class="at.a1ta.cuco.core.shared.dto.nbo.VBMDeclineReason">
    <result property="declineReasonId" column="REASON_ID" />
    <result property="declineReasonText" column="REASON_TXT" />
    <result property="productId" column="PRODUCT_ID" />
  </resultMap>

  <sql id="attributes_VBM_SCORING">
    KUNDE_ID, PRODUCT_ID,MONTH_YEAR_PERIOD , SCORING
  </sql>

  <sql id="attributes_VBM_PRODUCT">
    PRODUCT_ID, PRODUCT_PARTNERWEB_ID,PRODUCT_CLARIFY_ID ,
    PRODUCT_NAME,URL,MARKETING_TEXT,MAX_SCORING
  </sql>

  <sql id="attributes_VBM_SCORING_FEEDBACK">
    KUNDE_ID, PRODUCT_ID,MONTH_YEAR_PERIOD ,
    FEEDBACK_YN,FEEDBACK_REASON_ID,FEEDBACK_TS,FEEDBACK_USER_NAME,FEEDBACK_USER_ID
  </sql>

  <sql id="attributes_VBM_FEEDBACK_REASONS">
    REASON_ID,REASON_TXT,PRODUCT_ID
  </sql>

  <select id="getFeedbackForProdukt" resultMap="vbmProductFeedback-result" parameterClass="java.util.HashMap">
    SELECT
    <include refid="attributes_VBM_SCORING_FEEDBACK" />
    FROM VBM_SCORING_FEEDBACK
    <dynamic prepend="WHERE">
      <isNotNull prepend="AND" property="customerId">
        KUNDE_ID=#customerId#
      </isNotNull>
      <isNotNull prepend="AND" property="productId">
        PRODUCT_ID=#productId#
      </isNotNull>
      <isNotNull prepend="AND" property="monthYearPeriod">
        MONTH_YEAR_PERIOD=#monthYearPeriod#
      </isNotNull>
    </dynamic>
  </select>

  <select id="listAvailableOffersForKunde" resultMap="vbmProductScoring-result" parameterClass="java.util.HashMap">
    <!-- selectKey resultClass="long" keyProperty="attributeId">SELECT value AS threshold FROM bite_setting where key='vbm.scoring.threshold'</selectKey -->
    SELECT
    <include refid="attributes_VBM_SCORING" />
    FROM VBM_SCORING offer
    <dynamic prepend="WHERE">
      <isNotNull prepend="AND" property="customerId">
        offer.KUNDE_ID=#customerId#
      </isNotNull>
      <isNotNull prepend="AND" property="productId">
        offer.PRODUCT_NAME=#productId#
      </isNotNull>
      <isNotNull prepend="AND" property="monthYearPeriod">
        offer.MONTH_YEAR_PERIOD=#monthYearPeriod#
      </isNotNull>
      <isNotNull prepend="AND" property="scoreThreshold">
        
      </isNotNull>
       <isNotNull prepend="AND" property="customerId">
         offer.SCORING &gt;= (SELECT value FROM bite_setting where key='vbm.scoring.threshold')
         AND NOT EXISTS(
            select 1 from VBM_SCORING_FEEDBACK feedback 
                       where feedback.KUNDE_ID=offer.KUNDE_ID 
                         and feedback.PRODUCT_ID=offer.PRODUCT_ID 
                         and feedback.MONTH_YEAR_PERIOD=offer.MONTH_YEAR_PERIOD)
      </isNotNull>
    </dynamic>
    Order by  offer.SCORING desc
   
  </select>

  <!-- select id="listAvailableOffersForKundeHavingGivenProductIds" resultMap="vbmProductScoring-result" parameterClass="java.util.HashMap" cacheModel="vbmProducts-cache"> select <include refid="attributes_VBM_SCORING" /> FROM VBM_SCORING where kunde_id=any( SELECT kunde_id FROM VBM_SCORING <dynamic prepend="WHERE"> <isNotNull prepend="AND" property="customerId"> KUNDE_ID=#customerId# </isNotNull> <isNotNull prepend="AND" property="productId" open="(" close=")" conjunction="OR"> PRODUCT_NAME=#productId[]# 
    </isNotNull> </dynamic> ) </select -->

  <select id="getProduktInfo" resultMap="vbmProductInfo-result" parameterClass="java.util.HashMap">
    SELECT
    <include refid="attributes_VBM_PRODUCT" />
    FROM VBM_PRODUCT
    <dynamic prepend="WHERE">
      <isNotNull prepend="AND" property="productId">
        PRODUCT_ID=#productId#
      </isNotNull>
      <isNotNull prepend="AND" property="productName">
        PRODUCT_NAME=#productName#
      </isNotNull>
      <isNotNull prepend="AND" property="monthYearPeriod">
        MONTH_YEAR_PERIOD=#monthYearPeriod#
      </isNotNull>
    </dynamic>
  </select>

  <select id="getAvailableFeedbackReasons" resultMap="vbmFeedbackReasons-result" parameterClass="java.util.HashMap">
    SELECT
    <include refid="attributes_VBM_FEEDBACK_REASONS" />
    FROM VBM_FEEDBACK_REASON
    <dynamic prepend="WHERE">
      <isNotNull prepend="AND" property="declineReasonId">
        REASON_ID=#declineReasonId#
      </isNotNull>
      <isNotNull prepend="AND" property="declineReasonText">
        REASON_TXT=#declineReasonText#
      </isNotNull>
      <isNotNull prepend="AND" property="productId">
        PRODUCT_ID=#productId#
      </isNotNull>

    </dynamic>
  </select>

  <select id="getFeedbackReasonById" resultMap="vbmFeedbackReasons-result" parameterClass="java.util.HashMap">
    SELECT
    <include refid="attributes_VBM_FEEDBACK_REASONS" />
    FROM VBM_FEEDBACK_REASON
    where REASON_ID=#declineReasonId#
  </select>

  <insert id="registerFeedback" parameterClass="at.a1ta.cuco.core.shared.dto.nbo.VBMProductFeedback">
    insert into VBM_SCORING_FEEDBACK
    (KUNDE_ID,PRODUCT_ID,MONTH_YEAR_PERIOD,FEEDBACK_YN,FEEDBACK_REASON_ID,FEEDBACK_TS,FEEDBACK_USER_NAME,FEEDBACK_USER_ID)
    values
    (#customerId#, #productId#, #monthYearPeriod#, #feedBackGiven#, #selectedDeclineReason.declineReasonId#, #feedbackTime#,#feedbackUserName#, #feedbackUserId#)
  </insert>


</sqlMap>