<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="UserInfoStats">
  <typeAlias alias="stats" type="at.a1ta.cuco.core.shared.dto.UserInfoStatistics" />
  
  <cacheModel id="stats-cache" type="ehcacheProvider" readOnly="true">
    <flushInterval minutes="1" />
    <property name="cache-size" value="500" />
  </cacheModel>


  <resultMap id="stats-result" class="stats">
    <result property="nrOfCustomers" column="nrOfCustomers" />
    <result property="nrOfExpiringBindings" column="nrOfExpiringBindings" />
    <result property="nrOfQuotes" column="nrOfQuotes" />
    <result property="nrOfTasks" column="nrOfTasks" />
    <result property="nrOfOpenToDos" column="nrOfOpenToDos" />
  </resultMap>

  <select id="getStats" cacheModel="stats-cache" resultMap="stats-result">
    SELECT 
      (
        select /*+ parallel (8,3) */ ((SELECT count(*) FROM kunde_gesamt kunde_gesamt
           WHERE lower(kunde_gesamt.betreuer_uuser_cd) =lower(#uuser#)) +(
        SELECT count(*) FROM lead lead
           WHERE lower(lead.betreuer_uuser_cd) =lower(#uuser#) and MERGED_WITH_CUSTOMER='0')) from dual
      ) AS nrOfCustomers,  
      
      (
        SELECT /*+ parallel (8,3) */ COUNT(*) FROM v_bestand b,kunde_gesamt k
        WHERE betreuer_uuser_cd = lower(#uuser#)
        AND k.kunde_id = b.kunde_id
        AND b.vertragsbindung_dat &gt; SYSDATE
        AND b.vertragsbindung_dat &lt; SYSDATE + #bindingDayLimit#
      ) AS nrOfExpiringBindings,  
      
      (
       select /*+ parallel (8,3) */ count(*) from cct_quote q, cct_salesstage s,bite_user usr
        where lower(usr.login) = lower(#uuser#)
        and q.creator=usr.USER_ID
        and q.quote_id = s.quote_id
        and upper(s.status)='FINALIZED'
      ) as nrOfQuotes,
      
      (
        select /*+ parallel (8,3) */ count(*) from si_task t, bite_user u
        where u.user_id = t.assignee_user
        and lower(u.login) = lower(#uuser#)
        and t.active = 1
        and t.date_start > sysdate
      ) as nrOfTasks,
      
      (
        select /*+ parallel (8,3) */ count(*)
        from  si_note n,bite_user usr,si_todo_group_note gn
        where 
        n.deleted=0 and  n.si_note_class ='SI_TODO_GROUP_NOTE'
        and n.si_note_id=gn.si_note_id
        and lower(usr.login) = lower(#uuser#)
        and (usr.user_id = n.creator OR usr.user_id=n.last_modifier OR gn.ASSIGNEE_USER_ID=usr.user_id) 
        and upper(gn.todo_status) <![CDATA[<>'DONE']]>      
      ) as nrOfOpenToDos from dual
  </select>
</sqlMap>
