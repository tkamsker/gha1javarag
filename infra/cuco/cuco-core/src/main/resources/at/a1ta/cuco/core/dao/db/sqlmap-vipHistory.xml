<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="VIPHistory">

	<resultMap id="vipHistory-result" class="at.a1ta.cuco.core.shared.dto.VIPHistoryEntry">
		<result property="vipHistoryId" column="VIP_HISTORY_ID" />
		<result property="customerId" column="KUNDE_ID" />
		<result property="created" column="CREATION_DATE" />
		<result property="userId" column="BENUTZER_ID" />
		<result property="reported" column="REPORTED" />
		<result property="oldStatus" column="OLD_STATUS" />
		<result property="newStatus" column="NEW_STATUS" />
		<result property="name" column="NAME" />
	</resultMap>

	<insert id="SaveVIPHistory" parameterClass="at.a1ta.cuco.core.shared.dto.VIPHistoryEntry">
		<selectKey keyProperty="vipHistoryId" resultClass="java.lang.Long" type="pre">
			SELECT SEQ_CUCO_VIP_HISTORY.NEXTVAL AS id FROM DUAL
		</selectKey>
		insert into CUCO_VIP_HISTORY (VIP_HISTORY_ID, KUNDE_ID, BENUTZER_ID, REPORTED, OLD_STATUS, NEW_STATUS)
		VALUES(#vipHistoryId#, #customerId#, #userId#, #reported#, #oldStatus#, #newStatus#)
	</insert>

	<select id="GetVIPHistory" resultMap="vipHistory-result" parameterClass="java.lang.Long">
		select V.VIP_HISTORY_ID, V.KUNDE_ID, V.CREATION_DATE, V.BENUTZER_ID, V.REPORTED, V.OLD_STATUS, V.NEW_STATUS, u.NAME
		from cuco_vip_history v, bite_user u
		where kunde_id=#customerId# and u.user_id=v.benutzer_id
		order by VIP_HISTORY_ID desc
	</select>

	<select id="SearchVIPHistory" resultMap="vipHistory-result" parameterClass="java.util.Map">
		SELECT * FROM cuco_vip_history v, bite_user u
		WHERE u.user_id = v.benutzer_id
		<isNotNull property="from">
		 AND v.creation_date <![CDATA[>]]> #from#
		</isNotNull>
		<isNotNull property="to">
		 AND v.creation_date <![CDATA[<]]> #to#
		</isNotNull>
		<isNotEmpty property="searchTerm">
		 AND (LOWER(v.reported) like LOWER('%$searchTerm$%') OR LOWER(u.name) like LOWER('%$searchTerm$%') OR TO_CHAR(v.kunde_id) like '%$searchTerm$%')
		</isNotEmpty>
		<isPropertyAvailable property="vipStatus">
		 <isNull property="vipStatus" >
			 AND v.new_status is null
		 </isNull>
		 <isNotNull property="vipStatus" >
		 	AND v.new_status = #vipStatus#
		 </isNotNull>
		</isPropertyAvailable>
		ORDER BY v.vip_history_id DESC
	</select>

</sqlMap>
