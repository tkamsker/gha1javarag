<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="cucoSettings">
  <typeAlias alias="Setting" type="at.a1ta.bite.core.shared.dto.Setting" />

  <resultMap id="SettingResult" class="Setting">
    <result property="key" column="key" />
    <result property="value" column="value" />
    <result property="type" column="typ" />
    <result property="sensitive" column="sensitive" />
  </resultMap>

  <cacheModel id="CuCoSetting-cache" type="ehcacheProvider">
    <flushInterval minutes="1" />
    <property name="cache-size" value="1000" />
  </cacheModel>

  <select id="selectSettingProperty" resultMap="SettingResult" parameterClass="java.util.Map" cacheModel="CuCoSetting-cache">
    SELECT *
    FROM BITE_SETTING
    <dynamic prepend="WHERE">
      <isNotEmpty prepend="AND" property="startWith">
        key LIKE #startWith#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="sensitive">
        (sensitive = 0 OR
        sensitive = #sensitive#)
	  </isNotEmpty>
      <isNotEmpty prepend="AND" property="key">
        key = #key#
	   </isNotEmpty>
    </dynamic>
  </select>
  
   <select id="getSettings" resultMap="SettingResult">
    SELECT * FROM BITE_SETTING
    ORDER BY 1 ASC
  </select>

  <update id="updateSetting" parameterClass="Setting">
    UPDATE BITE_SETTING SET
      value = #value#,
      key=#key#,
      typ=#type#,
      sensitive=#sensitive#
    WHERE
      key = #key#
  </update>
  
  <select id="searchSetting" parameterClass="java.lang.String" resultMap="SettingResult">
    SELECT * FROM BITE_SETTING
    WHERE key in (
      SELECT key FROM BITE_TEXT 
      WHERE dbms_lob.instr(LOWER(value), LOWER(#value#)) > 0 
      UNION 
      SELECT key FROM BITE_TEXT 
      WHERE LOWER(key) like LOWER('%$value$%')
    )
    ORDER BY 1 ASC
  </select>

</sqlMap>