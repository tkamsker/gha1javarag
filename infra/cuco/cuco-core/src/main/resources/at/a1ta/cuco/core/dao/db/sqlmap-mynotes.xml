<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="MyNotes">
  <typeAlias alias="SalesInfoNote" type="at.a1ta.cuco.core.shared.dto.salesinfo.SalesInfoNote" />
  <typeAlias alias="Task" type="at.a1ta.cuco.core.shared.dto.salesinfo.Task" />

  <cacheModel type="ehcacheProvider" id="sales-info-cache">
    <flushOnExecute statement="SalesInfo.insertNote"/>
    <flushOnExecute statement="SalesInfo.updateNote"/>
    <flushInterval minutes="60" />
    <property name="cache-size" value="20" />
  </cacheModel>
  
  <cacheModel type="ehcacheProvider" id="task-cache">
    <flushOnExecute statement="SalesInfo.insertTask"/>
    <flushOnExecute statement="SalesInfo.updateTask"/>
    <flushOnExecute statement="SalesInfo.updateTaskReminderMailSentDate"/>
    <flushOnExecute statement="SalesInfo.updateTaskVcalMailSentInfo"/>
    <flushInterval minutes="60" />
    <property name="cache-size" value="20" />
  </cacheModel>
  
  <!-- For Overview -->
  
  <resultMap id="slim-si-note-resultmap" class="SalesInfoNote">
     <result property="salesInfoNoteId"             column="si_note_id" />
     <result property="salesInfoNoteType"           column="si_note_class" />
     <result property="partyId"                     column="kunde_id" />
     <result property="noteText"                    column="note_text" />
     <result property="status"                      column="status" />
     <result property="task"                        column="task_id" select="SalesInfo.getTask" />
     <result property="creationUser"                column="creator" select="User.getBiteUserById"/>
     <result property="lastModificationUser"        column="last_modifier" select="User.getBiteUserById"/>
     <result property="lastModificationTimestamp"   column="last_update" />
  </resultMap>
    
    
  <select id="LoadMyNotes" resultMap="slim-si-note-resultmap" parameterClass="java.util.HashMap" cacheModel="sales-info-cache">
      SELECT n.si_note_id, n.si_note_class, n.kunde_id, n.note_text, t.STATUS,n.task_id, n.creator, n.last_modifier, n.last_update
        FROM si_note n, si_task t, v_kunde k
       WHERE (last_modifier = #userId# 
              OR creator = #userId# 
              OR (t.assignee_user = #userId# AND t.active = 1)
             )
         AND si_note_class IN <iterate open="(" close=")" conjunction="," property="salesInfoNoteTypesToLoad">#salesInfoNoteTypesToLoad[]#</iterate>
         AND deleted = 0
         AND n.task_id = t.si_task_id
         AND n.kunde_id = k.kunde_id 
       <isNotNull property="creator">
         AND n.creator in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#creator#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#creator#) || '%' )
       </isNotNull>
       <isNotNull property="lastModifier">
         AND n.last_modifier in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#lastModifier#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#lastModifier#) || '%' )
       </isNotNull>
       <isNotNull property="assignee">
         AND t.assignee_user in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#assignee#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#assignee#) || '%' )
       </isNotNull>
       <isNotNull property="modDate">
         AND trunc(n.last_update) = trunc(#modDate#)
       </isNotNull>
       <isNotNull property="noteText">
         AND lower(n.note_text) like '%' || lower(#noteText#) || '%'  
       </isNotNull>
       <isNotNull property="status">
         AND t.STATUS =#status#
       </isNotNull>
       <isNotNull property="noteType">
         AND n.si_note_class = #noteType#
       </isNotNull>
       <isNotNull property="reminderOperator">
         AND t.date_start $reminderOperator$ sysdate
       </isNotNull>
       <isNotNull property="partyId">
         AND n.kunde_id = #partyId#       
       </isNotNull>
       <isNotNull property="firstname">
         AND lower(k.kunde_vorname) like lower(#firstname#) || '%' 
       </isNotNull>
       <isNotNull property="lastname">
         AND lower(k.kunde_nam) like lower(#lastname#) || '%' 
       </isNotNull>
       ORDER BY n.last_update DESC
  </select> 
  
  <!-- For Task -->
  
  <resultMap id="slim-task-resultmap" class="Task">
    <result property="taskId" column="si_task_id" />
    <result property="startDate" column="date_start" />
  </resultMap>
  
  <select id="getTaskSlim" resultMap="slim-task-resultmap" parameterClass="java.lang.Long" cacheModel="task-cache">
      SELECT si_task_id, date_start  
        FROM si_task
       WHERE si_task_id = #taskId#
  </select>
  
</sqlMap>