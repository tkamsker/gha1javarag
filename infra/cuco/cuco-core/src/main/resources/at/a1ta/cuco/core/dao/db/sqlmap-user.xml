<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="User">

  <typeAlias alias="biteUser" type="at.a1ta.bite.core.shared.dto.BiteUser" />

  <cacheModel id="app-user-cache" type="ehcacheProvider"/>
  <resultMap class="biteUser" id="biteUser-result-slim">
    <result property="id" column="user_id" />
    <result property="username" column="login" />
    <result property="firstName" column="firstname" />
    <result property="lastName" column="lastname" />
    <result property="email" column="email" />
  </resultMap>
  
  <resultMap class="biteUser" id="biteUser-result">
    <result property="id" column="user_id" />
    <result property="username" column="login" />
    <result property="firstName" column="firstname" />
    <result property="lastName" column="lastname" />
    <result property="email" column="email" />
    <result property="salesTitle" column="login" select="User.getRolleByUserName"/>
    <result property="managementLevel1OrgUnitNumber" column="ml1_orgunit_id" />
    <result property="managementLevel1OrgUnitShort" column="ml1_orgunit_short" />
    <result property="managementLevel1OrgUnitDescription" column="ml1_orgunit_desc" />
  
    <result property="managementLevel2OrgUnitNumber" column="ml2_orgunit_id" />
    <result property="managementLevel2OrgUnitShort" column="ml2_orgunit_short" />
    <result property="managementLevel2OrgUnitDescription" column="ml2_orgunit_desc" />
  
    <result property="managementLevel3OrgUnitNumber" column="ml3_orgunit_id" />
    <result property="managementLevel3OrgUnitShort" column="ml3_orgunit_short" />
    <result property="managementLevel3OrgUnitDescription" column="ml3_orgunit_desc" />
  
    <result property="managementLevel4OrgUnitNumber" column="ml4_orgunit_id" />
    <result property="managementLevel4OrgUnitShort" column="ml4_orgunit_short" />
    <result property="managementLevel4OrgUnitDescription" column="ml4_orgunit_desc" />
    <result property="assignedToShopIds" column="login" select="User.getUserShops" />
  </resultMap>


  <select id="getBiteUserById" cacheModel="app-user-cache" resultMap="biteUser-result" parameterClass="long">
    SELECT * FROM bite_user
    WHERE user_id = #id#
  </select>
  
   <select id="getBiteUserByIdSlim" cacheModel="app-user-cache" resultMap="biteUser-result-slim" parameterClass="long">
    SELECT * FROM bite_user
    WHERE user_id = #id#
  </select>
  
  <select id="getBiteUserByUserNameSlim" cacheModel="app-user-cache" resultMap="biteUser-result-slim" parameterClass="String">
    SELECT * FROM bite_user
    WHERE login = #username#
  </select>
  
  <select id="getAllLogin" resultClass="java.lang.String" parameterClass="java.util.ArrayList">
    SELECT lower(login) FROM bite_user
  </select>
  
    <select id="GetAllUsers" resultMap="biteUser-result" parameterClass="java.lang.String">
    SELECT u.*
      FROM bite_user u, bite_role_auth ra, bite_user_role ur, bite_auth auth
     WHERE 
        auth.name = #auth#   
     and
            auth.name = ra.auth
         and
            ra.role = ur.role
         and
            ur.user_id = u.user_id
  </select>
  
  <select id="getUserShops" resultClass="java.lang.String" parameterClass="java.lang.String">
    select shop.SHOPID from CUCO_USERSHOPASSIGNMENT shop where lower(shop.USERNAME)=lower(#login#) 
  </select>
  
  <select id="GetUsersForTeam" resultMap="biteUser-result" parameterClass="java.lang.Long">
    select u.* from bite_user u, cuco_team t, cuco_team_user tb
    where u.user_id = tb.user_id and t.team_id = tb.team_id
    and t.team_id = #teamId#
  </select>
  
  <select id="searchAll" resultMap="biteUser-result" parameterClass="java.util.Map" >
    select *  from bite_user  
    <dynamic prepend="where">
      <isNotEmpty prepend="and" removeFirstPrepend="true" property="usr">
        lower(LOGIN) like lower(#usr#)
      </isNotEmpty>
      <isNotEmpty prepend="and" removeFirstPrepend="true" property="name">
        lower(FIRSTNAME) like lower(#name#) or lower(LASTNAME) like lower(#name#)
      </isNotEmpty>
      <isNotEmpty prepend="and" removeFirstPrepend="true" property="orgunit">
         lower(ML1_ORGUNIT_SHORT) like lower(#orgunit#)
      </isNotEmpty>
    </dynamic>
  </select>
  
  <select id="getRolleByUserName" resultClass="java.lang.String" parameterClass="java.lang.String">
    SELECT a.ROLLE FROM CCT_APPROVER_HIERARCHY a
    <isParameterPresent>
    WHERE lower(a.USER_ID) = lower(#login#)
    </isParameterPresent>
  </select>
</sqlMap>
