<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="UsageData">

  <cacheModel id="voiceUsage-cache" type="ehcacheProvider" readOnly="true" serialize="false">
    <flushInterval hours="3" />
    <property name="cache-size" value="1000" />
  </cacheModel>
  
  <cacheModel id="inetUsage-cache" type="ehcacheProvider" readOnly="true" serialize="false">
    <flushInterval hours="3" />
    <property name="cache-size" value="1000" />
  </cacheModel>
  
  <cacheModel id="mobileUsage-cache" type="ehcacheProvider" readOnly="true" serialize="false">
    <flushInterval hours="3" />
    <property name="cache-size" value="1000" />
  </cacheModel>
  
  <resultMap id="fixedLine-result" class="at.a1ta.cuco.core.shared.dto.usagedata.VoiceUsage">
    <result property="date" column="monat_start" />
    <result property="duration" column="duration" />
    <result property="connectionFee" column="betrag" />
  </resultMap>
  
  <select id="GetFixedLineUsage" resultMap="fixedLine-result"
    parameterClass="java.util.Map" cacheModel="voiceUsage-cache">
    SELECT /*+ parallel (v_voice_nutzung,8) */  monat_start, 
      SUM(duration) AS duration,
      SUM(ve_bet) AS betrag
    FROM v_voice_nutzung
    <dynamic prepend="WHERE">
      <isNotNull property="customerId" prepend="AND">
           kunde_id = #customerId#
      </isNotNull>
      <isNotNull property="customerIds" prepend="AND">
           kunde_id IN <iterate open="(" close=")" conjunction="," property="customerIds">#customerIds[]#</iterate>
      </isNotNull>
      <isNotNull property="phoneNumber" prepend="AND">
           rufnummer like #phoneNumber#
      </isNotNull>
    </dynamic>
    GROUP BY monat_start
    ORDER BY monat_start
  </select>
  
  <resultMap id="voiceusage-zones_result" class="at.a1ta.cuco.core.shared.dto.usagedata.VoiceUsage">
    <result property="date" column="monat_start" />
    <result property="zone" column="zonen_3_bes" />
    <result property="duration" column="duration" />
    <result property="connectionFee" column="betrag" />
  </resultMap>

  <select id="GetFixedLineZoneUsage" resultMap="voiceusage-zones_result" parameterClass="java.util.Map" 
    cacheModel="voiceUsage-cache">
    SELECT monat_start, zonen_3_bes, SUM(duration) AS duration, SUM(ve_bet) AS betrag
      FROM v_voice_nutzung_detail
    <dynamic prepend="WHERE">
      <isNotNull property="customerId" prepend="AND">
             kunde_id = #customerId#
      </isNotNull>
      <isNotNull property="phoneNumber" prepend="AND">
             rufnummer like #phoneNumber#
      </isNotNull>
    </dynamic>
    GROUP BY monat_start, zonen_3_bes
    ORDER BY monat_start, zonen_3_bes
  </select>
  
  <resultMap id="voiceusage-result-timezones" class="at.a1ta.cuco.core.shared.dto.usagedata.VoiceUsage" groupBy="zeitfenster_cd">
    <result property="date" column="monat_start" />
    <result property="timeType" column="zeitfenster_cd" />
    <result property="duration" column="duration" />
  </resultMap>
  
  <select id="GetTimeZones" resultMap="voiceusage-result-timezones" parameterClass="java.util.Map" 
    cacheModel="voiceUsage-cache">
    SELECT monat_start, zeitfenster_cd, SUM(duration) AS duration
      FROM v_voice_nutzung_gzfz
      <dynamic prepend="WHERE">
        <isNotNull property="customerId" prepend="AND">
               kunde_id = #customerId#
        </isNotNull>
        <isNotNull property="phoneNumber" prepend="AND">
               rufnummer like #phoneNumber#
        </isNotNull>
      </dynamic>
    GROUP BY monat_start, zeitfenster_cd
    ORDER BY monat_start, zeitfenster_cd
  </select>
  

  <resultMap id="mobileUsage-result" class="at.a1ta.cuco.core.shared.dto.usagedata.MobileUsage">
    <result property="date" column="monat" />
    <result property="duration" column="duration" />
    <result property="connectionFees" column="connectionFees" />
    <result property="upload" column="upload" />
    <result property="download" column="download" />
    
    <result property="mou_ib_a_othermobiles_div" column="mou_ib_a_othermobiles_div" />
    <result property="mou_ib_a_international" column="mou_ib_a_international" />
    <result property="mou_ib_a_national" column="mou_ib_a_national" />
    <result property="mou_ib_a_mobilkom" column="mou_ib_a_mobilkom" />
    <result property="mou_ib_a_mobilbox" column="mou_ib_a_mobilbox" />
    <result property="mou_ib_a_services" column="mou_ib_a_services" />
    <result property="sms_a_sms" column="sms_a_sms" />
    
    <result property="chg_ib_a_othermobiles_div" column="chg_ib_a_othermobiles_div" />
    <result property="chg_ib_a_international" column="chg_ib_a_international" />
    <result property="chg_ib_a_national" column="chg_ib_a_national" />
    <result property="chg_ib_a_mobilkom" column="chg_ib_a_mobilkom" />
    <result property="chg_ib_a_mobilbox" column="chg_ib_a_mobilbox" />
    <result property="chg_ib_a_services" column="chg_ib_a_services" />
    <result property="chg_a_sms" column="chg_a_sms" />
    
    <result property="gbIbData" column="gb_ib_data" />
    <result property="gbObEuData" column="gb_ob_eu_data" />
    <result property="gbObInternationalData" column="gb_ob_international_data" />
    
    <result property="chg_ib_data" column="chg_ib_data" />
    <result property="chg_ob_eu_data" column="chg_ob_eu_data" />
    <result property="chg_ob_international_data" column="chg_ob_international_data" />
    
  </resultMap>

  <select id="GetMobileUsageData" resultMap="mobileUsage-result"
    parameterClass="java.util.Map" cacheModel="mobileUsage-cache">
    SELECT MONAT,

      SUM(MOU_IB_A + MOU_OB_A) as duration,
      SUM(chg_ib_a + chg_ib_p + chg_ob_a + chg_ob_p) as connectionFees,
      SUM(upl_ib_a_data + upl_ob_a_data)as upload,
      SUM(dnl_ib_a_data + dnl_ob_a_data)as download,
      
      SUM(mou_ib_a_mobilkom) as mou_ib_a_mobilkom,
      SUM(mou_ib_a_othermobiles_div) as mou_ib_a_othermobiles_div,
      SUM(mou_ib_a_international) as mou_ib_a_international,
      
      SUM(mou_ib_a_national) as mou_ib_a_national,
      SUM(mou_ib_a_mobilbox) as mou_ib_a_mobilbox,
      SUM(mou_ib_a_services) as mou_ib_a_services,
      SUM(sms_a_sms) as sms_a_sms,
      
      SUM(gb_ib_data) as gb_ib_data,
      SUM(gb_ob_eu_data) as gb_ob_eu_data,
      SUM(gb_ob_international_data) as gb_ob_international_data,
      
      SUM(chg_ib_a_othermobiles_div) as chg_ib_a_othermobiles_div,
      
      SUM(chg_ib_a_international) as chg_ib_a_international,
      SUM(chg_ib_a_national) as chg_ib_a_national,
      SUM(chg_ib_a_mobilkom) as chg_ib_a_mobilkom,
      SUM(chg_ib_a_mobilbox) as chg_ib_a_mobilbox,
      SUM(chg_ib_a_services) as chg_ib_a_services,
      SUM(chg_a_sms) as chg_a_sms,
      SUM(chg_ib_data) as chg_ib_data,
      SUM(chg_ob_eu_data) as chg_ob_eu_data,
      SUM(chg_ob_international_data) as chg_ob_international_data
      
    FROM v_mobil_nutzung
    
    <dynamic prepend="WHERE">
      <isNotNull property="customerId" prepend="AND">
           kunde_id = #customerId#
      </isNotNull>
      <isNotNull property="customerIds" prepend="AND">
           kunde_id IN <iterate open="(" close=")" conjunction="," property="customerIds">#customerIds[]#</iterate>
      </isNotNull>
      <isNotNull property="banId" prepend="AND">
           rufnummer in (SELECT LKZ || ' ' || ONKZ || ' ' || TN_NUM  from v_rufnummer where ban_id = #banId# AND rufnummerntyp_cd = 'M')
      </isNotNull>
      <isNotNull property="phoneNumber" prepend="AND">
           rufnummer like #phoneNumber#
      </isNotNull>
    </dynamic>
    GROUP BY MONAT
    ORDER BY MONAT
  </select>
  
  <resultMap id="inetusage-result" class="at.a1ta.cuco.core.shared.dto.usagedata.InetUsage">
    <result property="date" column="monat_start_dat" />
    <result property="subscriptionFee" column="grundentgelt_bet" />
    <result property="variableFee" column="variablesentgelt_bet" />
    <result property="highUsageFee" column="highusageentgelt_bet" />
    <result property="uploadVolume" column="uploadvolumen" />
    <result property="downloadVolume" column="downloadvolumen" />
    <result property="transferVolumeOverrun" column="volumen_ueberschreitung" />
    <result property="duration" column="duration" />
  </resultMap>
  
  <select id="GetAonUsageData" resultMap="inetusage-result"  parameterClass="java.util.Map" cacheModel="inetUsage-cache">
    SELECT n.monat_start_dat,
        SUM(n.volumen_ueberschreitung) as volumen_ueberschreitung,
        SUM(n.uploadvolumen) as uploadvolumen,
        SUM(n.downloadvolumen) as downloadvolumen,
        SUM(n.grundentgelt_bet) as grundentgelt_bet,
        SUM(n.variablesentgelt_bet) as variablesentgelt_bet,
        SUM(n.highusageentgelt_bet) as highusageentgelt_bet,
        SUM(n.duration) as duration
    FROM v_internet_nutzung n
       <dynamic prepend="WHERE">
          <isNotNull prepend="AND" property="customerId">
            n.kunde_id=#customerId#
          </isNotNull>
          <isNotNull prepend="AND" property="customerIds">
            n.kunde_id IN <iterate open="(" close=")" conjunction="," property="customerIds">#customerIds[]#</iterate>
          </isNotNull>
        <isNotNull  prepend="AND" property="phoneNumber">
           rufnummer like #phoneNumber#
      </isNotNull>
      </dynamic>
        GROUP BY n.monat_start_dat
        ORDER BY n.monat_start_dat ASC
  </select>
  
  <select id="GetFixedLineNumbers" resultClass="java.lang.String" parameterClass="long" >
    SELECT DISTINCT LKZ || ' ' || ONKZ || ' ' || TN_NUM as rufnummer
      FROM v_rufnummer
     WHERE kunde_id=#customerId#
       AND rufnummerntyp_cd in ('FV','FVI')
    ORDER BY rufnummer
  </select>

  <select id="GetMobileBans" resultClass="java.lang.String" parameterClass="long" >
     SELECT DISTINCT ban_id
      FROM v_rufnummer
     WHERE kunde_id=#customerId#
       AND rufnummerntyp_cd = 'M'
       AND not (ban_id is null)
    ORDER BY ban_id
  </select>

  <select id="GetMobileNumbers" resultClass="java.lang.String" parameterClass="java.util.Map" >
      SELECT DISTINCT LKZ || ' ' || ONKZ || ' ' || TN_NUM as rufnummer
      FROM v_rufnummer
     WHERE kunde_id=#customerId#
       AND ban_id = #banId#
       AND rufnummerntyp_cd = 'M'
       AND not (ban_id is null)
    ORDER BY rufnummer
  </select>
  
  <select id="GetAonNumbers" resultClass="java.lang.String" parameterClass="long">
     SELECT DISTINCT LKZ || ' ' || ONKZ || ' ' || TN_NUM as rufnummer
     FROM custc.v_rufnummer
     WHERE kunde_id=#customerId#
      AND rufnummerntyp_cd in ('FI','FVI')
    ORDER BY rufnummer
  </select>

</sqlMap>