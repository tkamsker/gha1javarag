<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="MyQuote">

  <typeAlias alias="MyOpportunity" type="at.a1ta.cuco.core.shared.dto.MyOpportunity" />
  <typeAlias alias="Quote" type="at.a1ta.cuco.cct.shared.dto.Quote" />
  <typeAlias alias="Opportunity" type="at.a1ta.cuco.cct.shared.dto.Opportunity" />
   <typeAlias alias="Salesstage" type="at.a1ta.cuco.core.shared.dto.Salesstage" />

  <resultMap id="myOpportunities-result-mycuco" class="MyOpportunity">
    <result property="partyid"           column="partyid" />
    <result property="leadId"           column="leadid" />
    <result property="partyType" column="partytype" nullValue="0" />
    <result property="quoteNumber"       column="quoteNumber" />
    <result property="firstname"         column="firstname" />
    <result property="lastname"          column="lastname" />
    <result property="creator"           column="creator" />
    <result property="creatorPerson"     column="creator" select="User.getBiteUserById" />
    <result property="lastModifier"      column="last_modifier" />
    <result property="lastModifierPerson" column="last_modifier" select="User.getBiteUserById" />
    <result property="productOffering"   column="productoffering_id" javaType="at.a1ta.cuco.core.shared.dto.ProductOffering"/>
    <result property="status"            column="status" />
    <result property="createDate"        column="create_date" />
    <result property="validToDate"       column="valid_to_date" />
    <result property="monthlyTurnoverFixed"  column="monthly_turnover_fixed" />
    <result property="monthlyTurnoverMobile" column="monthly_turnover_mobile" />
    <result property="monthlyTurnoverOther"  column="monthly_turnover_other" />
    <result property="onetimeCostTotal"      column="onetime_cost_total" />
    <result property="yearlyCostTotal"       column="yearly_cost_total" />
    <result property="monthlyCostTotal"      column="monthly_cost_total" />
    <result property="clearanceInitiator" column="clearance_initiator" />
    <result property="clearanceFinalApprover" column="clearance_final_approver" />
    <result property="clearancePendingWith" column="clearance_pending_with" />
  </resultMap>
   
  <select id="LoadMyOpportunities" resultMap="myOpportunities-result-mycuco" parameterClass="java.util.HashMap" fetchSize="5000">
    SELECT k.kunde_id             AS partyid,
           kunde_details.dual_segment AS partytype,
           q.quote_number         AS quoteNumber,
           k.kunde_vorname        AS firstname, 
           k.kunde_nam            AS lastname,
           q.creator              AS creator,
           q.last_modifier        AS last_modifier,
           pov.productoffering_id AS productoffering_id,
           s.status               AS status,
           q.create_date          AS create_date,
           q.valid_to             AS valid_to_date,
           NVL(q.monthly_turnover_fixed, 0.0)   AS monthly_turnover_fixed,
           NVL(q.monthly_turnover_mobile, 0.0)  AS monthly_turnover_mobile,
           NVL(q.monthly_turnover_other, 0.0)   AS monthly_turnover_other,
           NVL(q.onetime_cost_total, 0.0)       AS onetime_cost_total,
           NVL(q.yearly_cost_total, 0.0)        AS yearly_cost_total,
           NVL(q.monthly_cost_total, 0.0)       AS monthly_cost_total,
           0                      AS leadid,
           q.clearance_initiator AS clearance_initiator,
           q.clearance_final_approver AS clearance_final_approver,
           q.clearance_pending_with AS clearance_pending_with
      FROM cct_opportunity o, 
           cct_quote q, 
           v_kunde k,
           v_kunde_detail kunde_details, 
           cct_pov pov, 
           cct_salesstage s
     WHERE 1=1 
       <isNotNull prepend="AND" property="userId">
         lower(q.creator) = #userId#
       </isNotNull>
       <isNotNull prepend="AND" property="betreuer">
         lower(k.betreuer_uuser_cd) = #betreuer#
       </isNotNull>
       AND q.opportunity_id = o.opportunity_id
       AND k.kunde_id = o.party_id
       AND kunde_details.kunde_id=o.party_id
       AND pov.pov_id = o.pov_id
       AND s.quote_id = q.quote_id
       AND s.change_date IN (SELECT MAX(change_date) 
                              FROM cct_salesstage s1 
                             WHERE s1.quote_id = s.quote_id
                            )
       AND s.status != 'ARCHIVED'
       <isNotNull prepend="AND" property="createDate">
         trunc(q.create_date) <![CDATA[>=]]> trunc(#createDate:DATE#)
       </isNotNull>
       <isNotNull prepend="AND" property="validToDate">
         trunc(q.create_date) <![CDATA[<=]]> trunc(#validToDate:DATE#)
       </isNotNull>
       <isNotNull prepend="AND" property="quoteNumber">
         q.quote_number like '%$quoteNumber$%'
       </isNotNull>
       <isNotNull prepend="AND" property="partyId">
         to_char(k.kunde_id) like '%$partyId$%'
       </isNotNull>
       <isNotNull prepend="AND" property="firstName">
         lower(k.kunde_vorname) like lower('%$firstName$%')
       </isNotNull>
       <isNotNull prepend="AND" property="lastName">
         lower(k.kunde_nam) like lower('%$lastName$%')
       </isNotNull>
       <isNotNull prepend="AND" property="productOfferingName">
         pov.productoffering_id like '%$productOfferingName$%'
       </isNotNull>
       <isNotNull prepend="AND" property="status">
         s.status like '%$status$%'
       </isNotNull>
       <isNotNull prepend="AND" property="creatorName">
         lower(q.creator) in ( select user_id from bite_user where lower (firstname||' '||lastname) like lower ('%$creatorName$%') )
       </isNotNull>
       <isNotNull prepend="AND" property="lastModifierName">
         lower(q.last_modifier) in ( select user_id from bite_user where lower (firstname||' '||lastname) like lower ('%$lastModifierName$%') )
       </isNotNull>
       <isNotNull prepend="AND" property="clearanceUserId">
		(q.clearance_pending_with is not null AND (lower(q.clearance_initiator) = #clearanceUserId# OR lower(q.clearance_pending_with) = #clearanceUserId# OR lower(q.clearance_final_approver) = #clearanceUserId#))
       </isNotNull>
  </select> 
  
  <select id="LoadMyOpportunitiesForNonCustomers" resultMap="myOpportunities-result-mycuco" parameterClass="java.util.HashMap" fetchSize="5000">
    SELECT lead.party_id          AS partyid,
           lead.lead_id           AS leadid,
           9                      AS partytype,
           q.quote_number         AS quoteNumber,
           lead.lead_vorname      AS firstname, 
           lead.lead_nachnam      AS lastname,
           q.creator              AS creator,
           q.last_modifier        AS last_modifier,
           pov.productoffering_id AS productoffering_id,
           s.status               AS status,
           q.create_date          AS create_date,
           q.valid_to             AS valid_to_date,
           NVL(q.monthly_turnover_fixed, 0.0)   AS monthly_turnover_fixed,
           NVL(q.monthly_turnover_mobile, 0.0)  AS monthly_turnover_mobile,
           NVL(q.monthly_turnover_other, 0.0)   AS monthly_turnover_other,
           NVL(q.onetime_cost_total, 0.0)       AS onetime_cost_total,
           NVL(q.yearly_cost_total, 0.0)        AS yearly_cost_total,
           NVL(q.monthly_cost_total, 0.0)       AS monthly_cost_total,
           q.clearance_initiator AS clearance_initiator,
           q.clearance_final_approver AS clearance_final_approver,
           q.clearance_pending_with AS clearance_pending_with
      FROM cct_opportunity o, 
           cct_quote q, 
           lead lead,
           cct_pov pov, 
           cct_salesstage s
     WHERE 1=1 
       <isNotNull prepend="AND" property="userId">
         lower(q.creator) = #userId#
       </isNotNull>
       <isNotNull prepend="AND" property="betreuer">
         lower(lead.betreuer_uuser_cd) = #betreuer#
       </isNotNull>
       AND q.opportunity_id = o.opportunity_id
       AND lead.lead_id = o.lead_id
       AND pov.pov_id = o.pov_id
       AND s.quote_id = q.quote_id
       AND o.party_id='0'
       AND s.change_date IN (SELECT MAX(change_date) 
                              FROM cct_salesstage s1 
                             WHERE s1.quote_id = s.quote_id
                            )
       AND s.status != 'ARCHIVED'
        <isNotNull prepend="AND" property="createDate">
         trunc(q.create_date) <![CDATA[>=]]> trunc(#createDate:DATE#)
       </isNotNull>
       <isNotNull prepend="AND" property="validToDate">
         trunc(q.create_date) <![CDATA[<=]]> trunc(#validToDate:DATE#)
       </isNotNull>
       <isNotNull prepend="AND" property="quoteNumber">
         q.quote_number like '%$quoteNumber$%'
       </isNotNull>
       <isNotNull prepend="AND" property="partyId">
         to_char(lead.lead_id) like '%$partyId$%'
       </isNotNull>
       <isNotNull prepend="AND" property="firstName">
         lower(lead.lead_vorname) like lower('%$firstName$%')
       </isNotNull>
       <isNotNull prepend="AND" property="lastName">
         lower(lead.lead_nachnam) like lower('%$lastName$%')
       </isNotNull>
       <isNotNull prepend="AND" property="productOfferingName">
         pov.productoffering_id like '%$productOfferingName$%'
       </isNotNull>
       <isNotNull prepend="AND" property="status">
         s.status like '%$status$%'
       </isNotNull>
       <isNotNull prepend="AND" property="creatorName">
         lower(q.creator) in ( select user_id from bite_user where lower (firstname||' '||lastname) like lower ('%$creatorName$%') )
       </isNotNull>
       <isNotNull prepend="AND" property="lastModifierName">
         lower(q.last_modifier) in ( select user_id from bite_user where lower (firstname||' '||lastname) like lower ('%$lastModifierName$%') )
       </isNotNull>
      <isNotNull prepend="AND" property="clearanceUserId">
		(q.clearance_pending_with is not null AND (lower(q.clearance_initiator) = #clearanceUserId# OR lower(q.clearance_pending_with) = #clearanceUserId# OR  lower(q.clearance_final_approver) = #clearanceUserId#))
       </isNotNull>
  </select> 
    
 <resultMap id="myQuotesForOverview-result-mycuco" class="Quote">
  <result property="id"                          column="quote_id" />
  <result property="title"                       column="title" />
  <result property="quoteNumber"                 column="quote_number" />
  <result property="salesstages"                 column="quote_id" select="MyQuote.getForQuote"/>
  <result property="opportunity"                 column="opportunity_id" select="MyQuote.getOppForOverview"/>
  <result property="creator"                     column="creator" select="User.getBiteUserById"/>
  <result property="lastModifier"                column="last_modifier" select="User.getBiteUserById"/>
  <result property="lastUpdate"                  column="last_update" />
 </resultMap>
   
 <select id="loadMyQuotesForOverview" resultMap="myQuotesForOverview-result-mycuco" parameterClass="java.util.HashMap" fetchSize="5000">
   SELECT q.quote_id             AS quote_id,
          q.quote_number         AS quote_number,
          q.title                AS title,
          q.creator              AS creator,
          q.last_modifier        AS last_modifier,
          q.last_update          AS last_update,
          q.opportunity_id       AS opportunity_id
     FROM cct_opportunity o, 
          cct_quote q, 
          v_kunde k, 
          cct_salesstage s
    WHERE 1=1 
      <isNotNull prepend="AND" property="userId">
        q.creator = #userId#
      </isNotNull>
      AND q.opportunity_id = o.opportunity_id
      AND k.kunde_id = o.party_id
      AND s.quote_id = q.quote_id
      AND s.change_date IN (SELECT MAX(change_date) 
                             FROM cct_salesstage s1 
                            WHERE s1.quote_id = s.quote_id
                           )
      AND s.status != 'ARCHIVED'
       <isNotNull property="creatorName">
         AND q.creator in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#creatorName#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#creatorName#) || '%' )
       </isNotNull>
       <isNotNull property="lastModifier">
         AND q.last_modifier in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#lastModifier#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#lastModifier#) || '%' )
       </isNotNull>
       <isNotNull property="assignee">
         AND q.last_modifier in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#assignee#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#assignee#) || '%' )
       </isNotNull>
       <isNotNull property="modDate">
         AND trunc(q.last_update) = trunc(#modDate#)
       </isNotNull>
       <isNotNull property="title">
         AND lower(q.title) like '%' || lower(#title#) || '%' 
       </isNotNull>
       <isNotNull property="partyId">
         AND o.party_id = #partyId#       
       </isNotNull>
       <isNotNull property="firstName">
         AND lower(k.kunde_vorname) like lower(#firstName#) || '%' 
       </isNotNull>
       <isNotNull property="lastName">
         AND lower(k.kunde_nam) like lower(#lastName#) || '%' 
       </isNotNull>
       ORDER BY q.last_update DESC
  </select> 
  
  <select id="loadMyQuotesForOverviewForLeads" resultMap="myQuotesForOverview-result-mycuco" parameterClass="java.util.HashMap" fetchSize="5000">
   SELECT q.quote_id             AS quote_id,
          q.quote_number         AS quote_number,
          q.title                AS title,
          q.creator              AS creator,
          q.last_modifier        AS last_modifier,
          q.last_update          AS last_update,
          q.opportunity_id       AS opportunity_id
     FROM cct_opportunity o, 
          cct_quote q, 
          lead lead, 
          cct_salesstage s
    WHERE 1=1 
      <isNotNull prepend="AND" property="userId">
        q.creator = #userId#
      </isNotNull>
      AND q.opportunity_id = o.opportunity_id
      AND lead.lead_id = o.lead_id
      AND o.party_id=0
      AND s.quote_id = q.quote_id
      AND s.change_date IN (SELECT MAX(change_date) 
                             FROM cct_salesstage s1 
                            WHERE s1.quote_id = s.quote_id
                           )
      AND s.status != 'ARCHIVED'
       <isNotNull property="creatorName">
         AND q.creator in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#creatorName#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#creatorName#) || '%' )
       </isNotNull>
       <isNotNull property="lastModifier">
         AND q.last_modifier in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#lastModifier#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#lastModifier#) || '%' )
       </isNotNull>
       <isNotNull property="assignee">
         AND q.last_modifier in (select user_id from bite_user where lower(firstname||' '||lastname) like '%' || lower(#assignee#) || '%' or lower(lastname||' '||firstname) like '%' || lower(#assignee#) || '%' )
       </isNotNull>
       <isNotNull property="modDate">
         AND trunc(q.last_update) = trunc(#modDate#)
       </isNotNull>
       <isNotNull property="title">
         AND lower(q.title) like '%' || lower(#title#) || '%' 
       </isNotNull>
       <isNotNull property="partyId">
         AND o.lead_id = #partyId#       
       </isNotNull>
       <isNotNull property="firstName">
         AND lower(lead.lead_vorname) like lower(#firstName#) || '%' 
       </isNotNull>
       <isNotNull property="lastName">
         AND lower(lead.lead_nachnam) like lower(#lastName#) || '%' 
       </isNotNull>
       ORDER BY q.last_update DESC
  </select> 
  
  <resultMap class="Salesstage" id="salesstage-result">
    <result property="status" column="status"/>
    <result property="changeDate" column="change_Date"/>
    <result property="quoteId" column="quote_id"/>
    <result property="executor" column="executor" select="User.getBiteUserById"/>
  </resultMap>
  
  <select id="getForQuote" parameterClass="java.lang.Long" resultMap="salesstage-result">
    select * from cct_salesstage
    where quote_id = #id#
    order by change_date desc
  </select>
  
    <resultMap class="Opportunity" id="opportunity-result-overview">
    <result property="id" column="opportunity_id"/>
    <result property="partyId" column="party_id"/>
    <result property="leadId" column="lead_id"/>
    <result property="party" column="party_id_str" select="Customer.getByIdMinimal"/>
  </resultMap>
  
  <select id="getOppForOverview" parameterClass="java.lang.Long" resultMap="opportunity-result-overview">
    select opportunity_id,CASE 
                          WHEN party_id = '0' or party_id is null 
                          THEN lead_id 
                       ELSE cast(party_id as varchar(20)) 
                    END as party_id_str,party_id,lead_id
      from cct_opportunity
    <isParameterPresent>
    where opportunity_id = #id#
    </isParameterPresent>
  </select>
  
   <resultMap class="Quote" id="quote-result">
    <result property="quoteNumber" column="quote_number"/>
    <result property="opportunity" column="opportunity_id" select="Opportunity.getMinimal"/>
  </resultMap> 
  
  <select id="getOpportunityIdForQuoteNumber" parameterClass="java.lang.String">
    select opportunity_id from cct_quote 
    <isParameterPresent>
    where quote_number = #quoteNumber#
    </isParameterPresent>
  </select>
  
  <select id="loadPartyForQuoteNumber" resultClass="java.lang.String" parameterClass="java.lang.String">
    select party_id from cct_opportunity
    <isParameterPresent>
    where opportunity_id = #id#
    </isParameterPresent>
  </select>
  
    
    
</sqlMap>