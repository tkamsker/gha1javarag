<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Inventory">
	<cacheModel id="inventory-cache" type="ehcacheProvider" readOnly="true" serialize="false">
		<flushInterval hours="3" />
		<property name="cache-size" value="1000" />
	</cacheModel>

	<resultMap id="inventory-result" class="at.a1ta.cuco.core.shared.dto.Inventory">
		<result property="id" column="bestand_id" />
		<result property="customerId" column="kunde_id" />
		<result property="contractId" column="vertrag_id" />
		<result property="phoneNumber" column="rufnummer" />
		<result property="unlistedNumberIdentification" column="geheim_jn" />
		<result property="productDescription" column="produkt_bes" />
		<result property="validFromDate" column="gueltig_von_dat" />
		<result property="contractBindingDate" column="vertragsbindung_dat" />
		<result property="aonCustomerNumber" column="aon_kundennummer_id" />
		<result property="assetId" column="konto_id" />
        <result property="detailedDescription" column="produktdetail_bes" />
        <result property="productCategory" column="produktkategorie_typ_cd" />
        <result property="serviceDescription" column="service_bes" />
        <result property="productSsaId" column="ssa_produkt_id" />
        <result property="indexation" column="cpi_status" />
	</resultMap>

	<sql id="attributes_v_bestand">
		v_bestand.bestand_id, v_bestand.kunde_id, v_bestand.vertrag_id,
		v_bestand.rufnummer, v_bestand.geheim_jn, v_bestand.produkt_bes,
		v_bestand.gueltig_von_dat, v_bestand.vertragsbindung_dat, v_bestand.aon_kundennummer_id,
		v_bestand.konto_id, v_bestand.produktdetail_bes, v_bestand.produktkategorie_typ_cd, v_bestand.service_bes, v_bestand.ssa_produkt_id,v_bestand.cpi_status
	</sql>
  
  <resultMap id="filterBinding-result" class="at.a1ta.cuco.core.shared.dto.CustomerBinding">
    <result property="partyId" column="kunde_id" />
    <result property="productDescription" column="produkt_bes" />
    <result property="contractStart" column="gueltig_von_dat" />
    <result property="contractEnd" column="vertragsbindung_dat" />
    <result property="productNumber" column="rufnummer" />
    <result property="customer.id" column="KUNDE_ID"/>
    <result property="customer.firstname" column="KUNDE_VORNAME"/>
    <result property="customer.lastname" column="KUNDE_NAM"/>
    <result property="location.street" column="STRASSE" />
    <result property="location.houseNumber" column="HAUSNUMMER" />
    <result property="location.city" column="ORT" />
    <result property="location.zipCode" column="PLZ" />
    <result property="service" column="service_bes"/>
    <result property="productCategory" column="produktkategorie_typ_cd" />
    <result property="connectorSpecification" column="aspez_bes" />
    <result property="aonCustomerNumber" column="aon_kundennummer_id" />
    <result property="contractId" column="vertrag_id" />
    <result property="type" column="dual_segment" />
    <result property="indexation" column="cpi_status" />
  </resultMap>
  
  <sql id="attributes_filterBinding">
    v_bestand.kunde_id, v_bestand.produkt_bes,
    v_bestand.gueltig_von_dat, v_bestand.vertragsbindung_dat,
    v_bestand.rufnummer, v_bestand.service_bes,
    kunde_gesamt.kunde_vorname, kunde_gesamt.kunde_nam, kunde_gesamt.dual_segment,
    v_standort.strasse, v_standort.hausnummer, v_standort.ort, v_standort.plz, 
    v_bestand.produktkategorie_typ_cd, v_rufnummer.aspez_bes, v_bestand.aon_kundennummer_id, v_bestand.vertrag_id,v_bestand.cpi_status
  </sql>

	<select id="GetInventory4Customer" resultMap="inventory-result" cacheModel="inventory-cache">
		SELECT <include refid="attributes_v_bestand" />
		  FROM v_bestand
		  <dynamic prepend="WHERE">
              <isNotNull prepend="AND" property="customerIds">
                    v_bestand.kunde_id IN <iterate open="(" close=")" conjunction="," property="customerIds">#customerIds[]#</iterate>
              </isNotNull>
			  <isNotNull prepend="AND" property="customerId">
			  		v_bestand.kunde_id=#customerId#
			  </isNotNull>
			  <isNotNull prepend="AND" property="contractId">
			  		v_bestand.vertrag_id=#contractId#
			  </isNotNull>
              <isNotNull prepend="AND" property="filter.description">
                    LOWER(v_bestand.service_bes) LIKE LOWER('%$filter.description$%')
              </isNotNull>
              <isNotNull prepend="AND" property="filter.details">
                    LOWER(v_bestand.produktdetail_bes) LIKE LOWER('%$filter.details$%')
              </isNotNull>
              <isNotNull prepend="AND" property="filter.binding">
                    v_bestand.vertragsbindung_dat >= #filter.binding#
              </isNotNull>
              <isNotNull prepend="AND" property="filter.validFrom">
                    v_bestand.gueltig_von_dat >= #filter.validFrom#
              </isNotNull>
              <isNotNull prepend="AND" property="secretNumber">
                    LOWER(v_bestand.geheim_jn) &lt;&gt; 'n'
              </isNotNull>
              <isNotNull prepend="AND" property="noSecretNumber">
                    (LOWER(v_bestand.geheim_jn) = 'n' OR v_bestand.geheim_jn IS NULL)
              </isNotNull>
              <isNotNull prepend="AND" property="filter.indexation">
			  		v_bestand.cpi_status=#filter.indexation#
			  </isNotNull>
		  </dynamic>
		ORDER BY v_bestand.produkt_bes ASC
	</select>
  
    <select id="getExpiringContractDatesForNextMonth" resultClass="java.util.Date">
      SELECT v_bestand.vertragsbindung_dat
        FROM v_bestand inner join kunde_gesamt on v_bestand.kunde_id = kunde_gesamt.kunde_id
        <dynamic prepend="WHERE">
          <isNotNull prepend="AND" property="uUser">
              kunde_gesamt.betreuer_uuser_cd=#uUser#
          </isNotNull>
          <isNotNull prepend="AND" property="maxTimeRange">
              v_bestand.vertragsbindung_dat BETWEEN sysdate AND sysdate + #maxTimeRange#
          </isNotNull> 
        </dynamic>
      ORDER BY v_bestand.vertragsbindung_dat
    </select>
    
    <select id="getExpiredContracts" resultClass="java.lang.Integer" parameterClass="java.lang.String">
      SELECT COUNT(*)
        FROM v_bestand b inner join v_kunde k on b.kunde_id = k.kunde_id
        <dynamic prepend="WHERE">
          <isNotNull prepend="AND">
                lower(k.betreuer_uuser_cd)=lower(#uUser#)
          </isNotNull>
          <isNotNull prepend="AND">
              b.vertragsbindung_dat <![CDATA[<]]> sysdate
          </isNotNull> 
        </dynamic>
      ORDER BY b.vertragsbindung_dat
    </select>
        
     <select id="filterBindingsInfo" resultMap="filterBinding-result">
      SELECT <include refid="attributes_filterBinding" />
        FROM v_bestand,
        kunde_gesamt,
        v_standort,
        v_rufnummer
      WHERE 
            kunde_gesamt.kunde_id = v_rufnummer.kunde_id
        AND v_rufnummer.vertrag_id = v_bestand.vertrag_id
        AND v_standort.kunde_id = kunde_gesamt.kunde_id
        and v_bestand.kunde_id = kunde_gesamt.kunde_id
        AND v_rufnummer.lokation_id = v_standort.lokation_id(+)
        AND v_bestand.vertragsbindung_dat IS NOT NULL
        AND kunde_gesamt.betreuer_uuser_cd=#uUser#
        AND v_rufnummer.cpi_status = v_bestand.cpi_status
        <dynamic>
          <isNotNull prepend="AND" property="partyId">
                to_char(v_bestand.kunde_id) like '%$partyId$%'
          </isNotNull>
          <isNotNull prepend="AND" property="contractStart">
                v_bestand.gueltig_von_dat <![CDATA[>=]]> #contractStart#
          </isNotNull>
          <isNotNull prepend="AND" property="productDescription">
                (lower(v_bestand.produkt_bes) like lower('%$productDescription$%') or (v_bestand.produktkategorie_typ_cd = 'V' AND lower(v_rufnummer.aspez_bes) like lower('%$productDescription$%')))
          </isNotNull>
          <isNotNull property="contractFilter">
            <isEqual prepend="AND" property="contractFilter" compareValue="ALL_EXPIRED">
  		  		v_bestand.vertragsbindung_dat &lt;= sysdate
            </isEqual>
            <isEqual prepend="AND" property="contractFilter" compareValue="ALL_EXPIRING">
                v_bestand.vertragsbindung_dat &gt;= sysdate
            </isEqual>
          </isNotNull>
          <isNotNull prepend="AND" property="expireInDays">
            v_bestand.vertragsbindung_dat &gt; SYSDATE
            AND v_bestand.vertragsbindung_dat &lt; SYSDATE + #expireInDays#
          </isNotNull>
          <isNotNull prepend="AND" property="expireInFuture">
                v_bestand.vertragsbindung_dat &gt; sysdate+#expireInFuture#
          </isNotNull>
          
        </dynamic>
    </select>
    
    <select id="getProductName" resultClass="java.lang.String">
      SELECT produkt_bes
      FROM v_bestand 
      WHERE kunde_id = #customerId# AND 
            vertrag_id=#contractId# AND
            produkt_bes IS NOT NULL
        <dynamic>
          <isNotNull prepend="AND" property="aonNumber">
                aon_kundennummer_id=#aonNumber#
          </isNotNull>
        </dynamic>
        ORDER BY v_bestand.produkt_bes ASC
    </select>
    
    <select id="getAonNumber" resultClass="java.lang.Long">
      SELECT DISTINCT aon_kundennummer_id 
      FROM v_bestand 
      WHERE aon_kundennummer_id IS NOT NULL
      <dynamic>
        <isNotNull prepend="AND" property="customerId">
          kunde_id = #customerId# 
        </isNotNull>
        <isNotNull prepend="AND" property="contractId">
          vertrag_id = #contractId#
        </isNotNull>
        <isNotNull prepend="AND" property="productNumber">
          rufnummer = #productNumber#
        </isNotNull>
      </dynamic>
    </select>
    
</sqlMap>