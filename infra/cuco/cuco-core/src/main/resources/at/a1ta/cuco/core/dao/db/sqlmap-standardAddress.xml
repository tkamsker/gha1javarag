<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="StandardAddress">
  <typeAlias alias="StandardAddress" type="at.a1ta.cuco.core.shared.dto.StandardAddress" />
  <typeAlias alias="Country" type="at.a1ta.cuco.core.shared.dto.salesinfo.visitreport.sbs.Country" />

  <cacheModel type="ehcacheProvider" id="address-cache">
    <flushOnExecute statement="StandardAddress.insertAddress"/>
    <flushOnExecute statement="StandardAddress.updateAddress"/>
    <flushInterval minutes="60" />
    <property name="cache-size" value="20" />
  </cacheModel>
  
  <cacheModel type="ehcacheProvider" id="country-cache">
    <flushInterval minutes="60" />
    <property name="cache-size" value="20" />
  </cacheModel>
  
  <resultMap id="address-resultmap" class="StandardAddress">
    <result property="addressId" column="address_id" />
    <result property="lkmsId" column="lkms_id" />
    <result property="partyId" column="kunde_id" />
    <result property="street" column="street" />
    <result property="houseNumber" column="house_number" />
    <result property="block" column="block" />
    <result property="staircase" column="staircase" />
    <result property="floorNumber" column="floor_number" />
    <result property="doorNumber" column="door_number" />
    <result property="additional" column="additional" />
    <result property="postcode" column="postcode" />
    <result property="city" column="city" />
    <result property="country" column="country" />
    <result property="creationUser" column="creation_user" select="User.getBiteUserById"/>
    <result property="creationDate" column="creation_date" />
    <result property="lastModificationUser" column="last_modifier" select="User.getBiteUserById"/>
    <result property="lastModificationDate" column="last_update" />
    <result property="dataSource" column="data_source" />
  </resultMap>
  
  <resultMap id="country-resultmap" class="Country">
     <result property="iso3166Alpha2"               column="iso_3166_1_alpha_2" />
     <result property="iso3166Alpha3"               column="iso_3166_1_alpha_3" />
     <result property="nameGerman"                  column="name_german" />
  </resultMap>
  
  <select id="getAddress" resultMap="address-resultmap" parameterClass="java.lang.Long" cacheModel="address-cache">
      SELECT *
        FROM cuco_standard_address
       WHERE address_id = #addressId#
  </select>
  
  <select id="getAddressByLkmsIdAndPartyId" resultMap="address-resultmap" cacheModel="address-cache">
      SELECT *
        FROM cuco_standard_address
      WHERE lkms_id=#lkmsId# AND kunde_id=#partyId#
  </select>
  
  <select id="loadCountries" resultMap="country-resultmap" cacheModel="country-cache">
    select *
    from cuco_country
    order by name_german asc
  </select>
  
  <insert id="insertAddress" parameterClass="StandardAddress">
    <selectKey resultClass="long" keyProperty="addressId">SELECT seq_cuco_standard_address.nextval AS addressId FROM dual</selectKey>
    insert into cuco_standard_address 
     (address_id, lkms_id, kunde_id, street, house_number, block, staircase, floor_number, door_number, additional, postcode, city, country, creation_user, creation_date, last_modifier, last_update, data_source)
    values 
     (#addressId#, #lkmsId#, #partyId#, #street#, #houseNumber#, #block#, #staircase#, #floorNumber#, #doorNumber#, #additional#, #postcode#, #city#, #country#, #creationUser.id#, #creationDate#, #lastModificationUser.id#, #lastModificationDate#, #dataSource#)
  </insert>
  
  <update id="updateAddress" parameterClass="StandardAddress">
    update cuco_standard_address 
       set lkms_id= #lkmsId#, 
           street= #street#, 
           house_number= #houseNumber#, 
           block= #block#, 
           staircase= #staircase#, 
           floor_number= #floorNumber#, 
           door_number= #doorNumber#, 
           additional= #additional#, 
           postcode= #postcode#, 
           city= #city#, 
           country= #country#,
           last_modifier = #lastModificationUser.id#,
           last_update = #lastModificationDate#,
           data_source = #dataSource#
     WHERE address_id = #addressId#
  </update>  
  
</sqlMap>